<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player - User</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
        }

        .menu-item {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .menu-item:hover, .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }

        .logout-btn {
            margin-top: auto;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            color: #667eea;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .section-title {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
        }

        .songs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .song-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .song-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .song-cover {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            object-fit: cover;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: cover;
        }

        .song-info {
            margin-bottom: 15px;
        }

        .song-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .song-artist {
            font-size: 14px;
            color: #666;
        }

        .song-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-play {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-favorite {
            background: #ff4757;
            color: white;
        }

        .btn-favorite.active {
            background: #ff6b81;
        }

        .btn-queue {
            background: #5f27cd;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .clear-queue-btn {
            padding: 12px 24px;
            font-size: 14px;
        }

        .player {
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .player-cover img {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: cover;
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-title {
            font-weight: bold;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-artist {
            font-size: 12px;
            color: #666;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 55px;
            height: 55px;
            font-size: 22px;
        }

        .player-progress {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            position: relative;
            transition: width 0.1s linear;
        }

        .progress-dot {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: rgba(255,255,255,0.7);
        }

        .empty-state-text {
            font-size: 18px;
            opacity: 0.9;
        }

        /* Audio element (hidden) */
        #audioPlayer {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .playlist-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .playlist-item {
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-item:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-name {
            font-weight: bold;
            font-size: 16px;
        }

        .playlist-count {
            font-size: 12px;
            opacity: 0.8;
        }

        .playlist-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(255,255,255,0.3);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <!-- Hidden Audio Element -->
    <audio id="audioPlayer"></audio>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">Music Player</div>
        <div class="menu-item active" onclick="showSection('all')">
            Home
        </div>
        <div class="menu-item" onclick="showSection('library')">
            Library
        </div>
        <div class="menu-item" onclick="showSection('favorites')">
            Favorites
        </div>
        <div class="menu-item" onclick="showSection('playlists')">
            Playlists
        </div>
        <div class="menu-item" onclick="showSection('queue')">
            Queue
        </div>
        <div class="menu-item" onclick="showSection('history')">
            History
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search songs or artists..." onkeyup="searchSongs()">
            </div>
            <div class="user-info">
                User
            </div>
        </div>

        <!-- Content Area -->
        <div class="content" id="contentArea">
            <div class="section-title">All Songs</div>
            <div class="songs-grid" id="songsGrid">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <div class="empty-state-text">Loading songs...</div>
                </div>
            </div>
        </div>

        <!-- Player -->
        <div class="player">
            <div class="player-cover" id="playerCover">‚ô™</div>
            <div class="player-info">
                <div class="player-title" id="playerTitle">No song playing</div>
                <div class="player-artist" id="playerArtist">Select a song to play</div>
            </div>
            <div class="player-controls">
                <button class="control-btn" onclick="previousSong()">‚èÆ</button>
                <button class="control-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂</button>
                <button class="control-btn" onclick="nextSong()">‚è≠</button>
            </div>
            <div class="player-progress">
                <div class="progress-bar" onclick="seekAudio(event)">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-dot"></div>
                    </div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div class="modal" id="playlistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add to Playlist</h2>
                <button class="close-btn" onclick="closePlaylistModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <button class="btn btn-play" onclick="openCreatePlaylistForm()" style="width: 100%;">
                    Create New Playlist
                </button>
            </div>

            <div class="playlist-list" id="playlistList">
                <div style="text-align: center; padding: 20px; color: #999;">
                    Loading playlists...
                </div>
            </div>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div class="modal" id="createPlaylistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Playlist</h2>
                <button class="close-btn" onclick="closeCreatePlaylistModal()">&times;</button>
            </div>
            
            <form id="createPlaylistForm" onsubmit="createPlaylist(event)">
                <div class="form-group">
                    <label for="playlistName">Playlist Name</label>
                    <input type="text" id="playlistName" placeholder="My Awesome Playlist" required>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" style="background: #999;" onclick="closeCreatePlaylistModal()">Cancel</button>
                    <button type="submit" class="btn btn-play">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let allSongs = [];
        let favorites = [];
        let queue = [];
        let history = [];
        let playlists = [];
        let currentSong = null;
        let isPlaying = false;
        let currentSection = 'all';
        let selectedSongForPlaylist = null;
        
        const audioPlayer = document.getElementById('audioPlayer');

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadSongs();
            loadFavorites();
            loadQueue();
            loadHistory();
            loadPlaylists();
            setupAudioListeners();
            
            // Auto refresh every 5 seconds
            setInterval(() => {
                loadSongs();
                loadFavorites();
                loadQueue();
                loadPlaylists();
            }, 5000);
        });

        function logout() {
            window.location.href = '/logout';
        }

        // Setup audio event listeners
        function setupAudioListeners() {
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', onSongEnded);
            audioPlayer.addEventListener('loadedmetadata', onAudioLoaded);
            audioPlayer.addEventListener('error', onAudioError);
            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                document.getElementById('playPauseBtn').textContent = '‚è∏';
            });
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                document.getElementById('playPauseBtn').textContent = '‚ñ∂';
            });
        }

        function onAudioLoaded() {
            const duration = audioPlayer.duration;
            document.getElementById('totalTime').textContent = formatTime(duration);
        }

        function onAudioError(e) {
            console.error('Audio error:', e);
            alert('Error playing audio. The file may be missing or corrupted.');
            
            // Reset player
            isPlaying = false;
            document.getElementById('playPauseBtn').textContent = '‚ñ∂';
        }

        function updateProgress() {
            if (!audioPlayer.duration) return;
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        }

        function seekAudio(event) {
            if (!audioPlayer.duration) return;
            
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        function onSongEnded() {
            nextSong();
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Load songs
        async function loadSongs() {
            try {
                const response = await fetch('/api/songs', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load songs');
                
                const data = await response.json();
                allSongs = data.songs || [];
                
                if (currentSection === 'all' || currentSection === 'library') {
                    displaySongs(allSongs);
                }
            } catch (error) {
                console.error('Error loading songs:', error);
            }
        }

        // Load favorites
        async function loadFavorites() {
            try {
                const response = await fetch('/api/favorites', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load favorites');
                
                const data = await response.json();
                favorites = data.favorites || [];
                
                if (currentSection === 'favorites') {
                    displaySongs(favorites);
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        // Load queue
        async function loadQueue() {
            try {
                const response = await fetch('/api/queue', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load queue');
                
                const data = await response.json();
                queue = data.queue || [];
                
                if (currentSection === 'queue') {
                    displaySongs(queue);
                }
            } catch (error) {
                console.error('Error loading queue:', error);
            }
        }

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch('/api/history', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load history');
                
                const data = await response.json();
                history = data.history || [];
                
                if (currentSection === 'history') {
                    displaySongs(history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Display songs
        function displaySongs(songs) {
            const grid = document.getElementById('songsGrid');
            
            if (!songs || songs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">No songs available</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = songs.map(song => {
                const isFavorite = favorites.some(f => f.id === song.id);
                const hasAudio = song.audio_path && song.audio_path !== 'null';
                const isInQueue = currentSection === 'queue';
                
                return `
                    <div class="song-card">
                        <div class="song-cover">
                            ${song.cover_path && song.cover_path !== 'null'
                                ? `<img src="${song.cover_path}" alt="${song.title}">`
                                : '‚ô™'}
                        </div>
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist} ‚Ä¢ ${song.genre}</div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-play" onclick="playSong(${song.id})" ${!hasAudio ? 'disabled' : ''}>
                                ${hasAudio ? 'Play' : 'No Audio'}
                            </button>
                            ${!isInQueue ? `
                                <button class="btn btn-favorite ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${song.id})">
                                    ${isFavorite ? 'Favorited' : 'Favorite'}
                                </button>
                                <button class="btn btn-queue" onclick="addToQueue(${song.id})">
                                    Add Queue
                                </button>
                                <button class="btn btn-queue" onclick="openPlaylistModal(${song.id})">
                                    Add Playlist
                                </button>
                            ` : `
                                <button class="btn btn-danger" onclick="removeFromQueue(${song.id})">
                                    Remove
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Play song
        async function playSong(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (!song) {
                alert('Song not found');
                return;
            }
            
            if (!song.audio_path || song.audio_path === 'null') {
                alert('This song has no audio file uploaded');
                return;
            }
            
            currentSong = song;
            
            // Update player UI
            document.getElementById('playerTitle').textContent = song.title;
            document.getElementById('playerArtist').textContent = song.artist;
            
            const playerCover = document.getElementById('playerCover');
            if (song.cover_path && song.cover_path !== 'null') {
                playerCover.innerHTML = `<img src="${song.cover_path}" alt="${song.title}">`;
            } else {
                playerCover.innerHTML = '‚ô™';
            }
            
            // Load and play audio
            audioPlayer.src = song.audio_path;
            audioPlayer.load();
            
            try {
                await audioPlayer.play();
                
                // Add to history
                await fetch(`/api/history/${songId}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                loadHistory();
            } catch (error) {
                console.error('Error playing song:', error);
                alert('Failed to play audio');
            }
        }

        function togglePlayPause() {
            if (!currentSong) {
                alert('No song selected');
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play();
            }
        }

        async function nextSong() {
            // Priority: Queue > History > All Songs
            if (queue.length > 0) {
                const nextInQueue = queue[0];
                await playSong(nextInQueue.id);
                
                // Remove from queue
                await fetch('/api/queue/next', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                loadQueue();
            } else if (allSongs.length > 0) {
                const currentIndex = allSongs.findIndex(s => s.id === currentSong?.id);
                const nextIndex = (currentIndex + 1) % allSongs.length;
                await playSong(allSongs[nextIndex].id);
            }
        }

        async function previousSong() {
            if (history.length > 1) {
                const prevSong = history[history.length - 2];
                await playSong(prevSong.id);
            }
        }

        // Toggle favorite
        async function toggleFavorite(songId) {
            const isFavorite = favorites.some(f => f.id === songId);
            
            try {
                const url = `/api/favorites/${songId}`;
                const method = isFavorite ? 'DELETE' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    loadFavorites();
                    
                    // Refresh current view
                    if (currentSection === 'all') {
                        displaySongs(allSongs);
                    }
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
            }
        }

        // Add to queue
        async function addToQueue(songId) {
            try {
                const response = await fetch(`/api/queue/${songId}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('Added to queue!');
                    loadQueue();
                }
            } catch (error) {
                console.error('Error adding to queue:', error);
            }
        }

        // Remove from queue
        async function removeFromQueue(songId) {
            try {
                const response = await fetch(`/api/queue/${songId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    await loadQueue();
                    displaySongs(queue);
                    alert('Removed from queue!');
                }
            } catch (error) {
                console.error('Error removing from queue:', error);
            }
        }

        // Clear all queue
        async function clearAllQueue() {
            if (!confirm('Clear all songs from queue?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/queue/clear', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    await loadQueue();
                    displaySongs(queue);
                    alert('Queue cleared!');
                }
            } catch (error) {
                console.error('Error clearing queue:', error);
            }
        }

        // Show section
        function showSection(section) {
            currentSection = section;
            
            // Update menu active state
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            const titleMap = {
                'all': 'All Songs',
                'library': 'Library',
                'favorites': 'Favorites',
                'playlists': 'My Playlists',
                'queue': 'Queue',
                'history': 'History'
            };
            
            document.querySelector('.section-title').textContent = titleMap[section];
            
            // Add clear queue button if in queue section
            const contentArea = document.getElementById('contentArea');
            const existingButton = contentArea.querySelector('.clear-queue-btn');
            if (existingButton) {
                existingButton.remove();
            }
            
            if (section === 'queue' && queue.length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-danger clear-queue-btn';
                clearBtn.style.marginBottom = '20px';
                clearBtn.textContent = 'Clear All Queue';
                clearBtn.onclick = clearAllQueue;
                contentArea.insertBefore(clearBtn, contentArea.querySelector('.songs-grid'));
            }
            
            // Display appropriate content
            if (section === 'playlists') {
                displayPlaylistsView();
            } else {
                switch(section) {
                    case 'all':
                    case 'library':
                        displaySongs(allSongs);
                        break;
                    case 'favorites':
                        displaySongs(favorites);
                        break;
                    case 'queue':
                        displaySongs(queue);
                        break;
                    case 'history':
                        displaySongs(history);
                        break;
                }
            }
        }

        // Search songs
        function searchSongs() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query) {
                displaySongs(allSongs);
                return;
            }
            
            const filtered = allSongs.filter(song => 
                song.title.toLowerCase().includes(query) ||
                song.artist.toLowerCase().includes(query) ||
                song.genre.toLowerCase().includes(query)
            );
            
            displaySongs(filtered);
        }

        // === PLAYLIST FUNCTIONS ===

        // Load playlists
        async function loadPlaylists() {
            try {
                const response = await fetch('/api/playlists', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load playlists');
                
                const data = await response.json();
                playlists = data.playlists || [];
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        }

        // Open playlist modal
        function openPlaylistModal(songId) {
            selectedSongForPlaylist = songId;
            document.getElementById('playlistModal').classList.add('active');
            displayPlaylists();
        }

        function closePlaylistModal() {
            document.getElementById('playlistModal').classList.remove('active');
            selectedSongForPlaylist = null;
        }

        // Display playlists in modal
        function displayPlaylists() {
            const listEl = document.getElementById('playlistList');
            
            if (!playlists || playlists.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        No playlists yet. Create one!
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = playlists.map(playlist => `
                <div class="playlist-item" onclick="addSongToPlaylist('${playlist.name}')">
                    <div class="playlist-info">
                        <div class="playlist-name">${playlist.name}</div>
                        <div class="playlist-count">${playlist.count} songs</div>
                    </div>
                    <div class="playlist-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); viewPlaylist('${playlist.name}')">View</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deletePlaylist('${playlist.name}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Display playlists view in main content
        function displayPlaylistsView() {
            const grid = document.getElementById('songsGrid');
            
            if (!playlists || playlists.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <div class="empty-state-text">No playlists yet. Click "Create New Playlist" to get started!</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-play" onclick="openCreatePlaylistModal()" style="padding: 15px 30px; font-size: 16px;">
                            Create New Playlist
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-play" onclick="openCreatePlaylistModal()" style="padding: 12px 24px;">
                        Create New Playlist
                    </button>
                </div>
                ${playlists.map(playlist => `
                    <div class="song-card" style="cursor: pointer;" onclick="viewPlaylistFromMenu('${playlist.name}')">
                        <div class="song-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: bold;">
                            ${playlist.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="song-info">
                            <div class="song-title">${playlist.name}</div>
                            <div class="song-artist">${playlist.count} songs</div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-play" onclick="event.stopPropagation(); viewPlaylistFromMenu('${playlist.name}')">
                                View Playlist
                            </button>
                            <button class="btn btn-queue" onclick="event.stopPropagation(); deletePlaylistFromMenu('${playlist.name}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function openCreatePlaylistModal() {
            document.getElementById('createPlaylistModal').classList.add('active');
        }

        function viewPlaylistFromMenu(playlistName) {
            const playlist = playlists.find(p => p.name === playlistName);
            
            if (!playlist) {
                alert('Playlist not found');
                return;
            }
            
            currentSection = 'playlist_view';
            document.querySelector('.section-title').textContent = playlist.name;
            displaySongs(playlist.songs);
            
            // Update menu active state
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        async function deletePlaylistFromMenu(playlistName) {
            if (!confirm(`Delete playlist "${playlistName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/playlists/${encodeURIComponent(playlistName)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Playlist deleted!');
                    await loadPlaylists();
                    displayPlaylistsView();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting playlist:', error);
                alert('Failed to delete playlist');
            }
        }

        // Open create playlist form
        function openCreatePlaylistForm() {
            document.getElementById('playlistModal').classList.remove('active');
            document.getElementById('createPlaylistModal').classList.add('active');
        }

        function closeCreatePlaylistModal() {
            document.getElementById('createPlaylistModal').classList.remove('active');
            document.getElementById('createPlaylistForm').reset();
        }

        // Create playlist
        async function createPlaylist(event) {
            event.preventDefault();
            
            const name = document.getElementById('playlistName').value.trim();
            
            if (!name) {
                alert('Please enter a playlist name');
                return;
            }
            
            try {
                const response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Playlist created successfully!');
                    closeCreatePlaylistModal();
                    loadPlaylists();
                    
                    // If creating from add song modal, reopen it
                    if (selectedSongForPlaylist) {
                        setTimeout(() => {
                            openPlaylistModal(selectedSongForPlaylist);
                        }, 100);
                    }
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert('Failed to create playlist');
            }
        }

        // Add song to playlist
        async function addSongToPlaylist(playlistName) {
            if (!selectedSongForPlaylist) return;
            
            try {
                const response = await fetch(`/api/playlists/${encodeURIComponent(playlistName)}/songs/${selectedSongForPlaylist}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Added to "${playlistName}"!`);
                    closePlaylistModal();
                    loadPlaylists();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding song to playlist:', error);
                alert('Failed to add song to playlist');
            }
        }

        // View playlist
        function viewPlaylist(playlistName) {
            const playlist = playlists.find(p => p.name === playlistName);
            
            if (!playlist) {
                alert('Playlist not found');
                return;
            }
            
            closePlaylistModal();
            
            currentSection = 'playlist';
            document.querySelector('.section-title').textContent = `üìÅ ${playlistName}`;
            displaySongs(playlist.songs);
            
            // Update menu active state
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // Delete playlist
        async function deletePlaylist(playlistName) {
            if (!confirm(`Delete playlist "${playlistName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/playlists/${encodeURIComponent(playlistName)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Playlist deleted!');
                    loadPlaylists();
                    displayPlaylists();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting playlist:', error);
                alert('Failed to delete playlist');
            }
        }
    </script>
</body>
</html>
